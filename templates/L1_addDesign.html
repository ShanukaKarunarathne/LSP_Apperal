<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="page_title">LSP Apparel - Add Design</title>
    <style>
        /* CSS Variables for Theming */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f7fafc;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --accent-primary: #38a169;
            --accent-primary-hover: #2f855a;
            --border-color: #e2e8f0;
            --border-focus-color: #38a169;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --error-color: #e53e3e;
            --success-color: #38a169;
            --body-bg: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
        }

        body.dark-mode {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --text-primary: #edf2f7;
            --text-secondary: #a0aec0;
            --accent-primary: #48bb78;
            --accent-primary-hover: #38a169;
            --border-color: #4a5568;
            --border-focus-color: #48bb78;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --error-color: #f56565;
            --success-color: #48bb78;
            --body-bg: #171923;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--body-bg);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .controls-container {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .back-btn {
            padding: 0.75rem 1.5rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 2px 5px var(--shadow-color);
        }

        .back-btn:hover {
            background: var(--accent-primary);
            color: white;
            transform: translateY(-2px);
        }

        .language-switcher, .theme-switcher {
            display: flex;
            align-items: center;
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 5px;
            border: 1px solid var(--border-color);
        }

        .lang-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 600;
            padding: 5px 10px;
            color: var(--text-secondary);
            border-radius: 15px;
        }

        .lang-btn.active {
            background: var(--accent-primary);
            color: white;
        }

        .theme-switch-wrapper {
            display: flex;
            align-items: center;
        }

        .theme-switch {
            display: inline-block;
            height: 24px;
            position: relative;
            width: 44px;
        }

        .theme-switch input {
            display: none;
        }

        .slider {
            background-color: var(--border-color);
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            background-color: #fff;
            bottom: 4px;
            content: "";
            height: 16px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 16px;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--accent-primary);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .form-container, .history-container {
            background: var(--bg-primary);
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px var(--shadow-color);
            max-width: 1200px;
            margin: 0 auto 2rem;
        }

        h1 {
            color: var(--accent-primary);
            font-size: 2.25rem;
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 700;
        }

        h2 {
            color: var(--accent-primary);
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            font-weight: 700;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 1rem;
        }

        .input-group input, .input-group select {
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1.05rem;
            outline: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .input-group input:focus, .input-group select:focus {
            border-color: var(--border-focus-color);
            box-shadow: 0 0 0 3px rgba(56, 161, 105, 0.2);
        }

        .input-group input:invalid:not(:placeholder-shown) {
            border-color: var(--error-color);
        }

        .input-group input:valid:not(:placeholder-shown) {
            border-color: var(--success-color);
        }

        .size-distribution-section {
            grid-column: 1 / -1;
            margin-top: 1rem;
        }

        .size-distribution-section h3 {
            color: var(--accent-primary);
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .size-inputs-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .size-category-selection {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .category-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-primary);
        }

        .category-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }

        .size-category-container {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .size-category-container h4 {
            color: var(--accent-primary);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .size-inputs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }

        .size-inputs-grid .input-group {
            margin-bottom: 0;
        }

        .size-inputs-grid label {
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .size-inputs-grid input {
            padding: 0.75rem;
        }

        .size-input-row {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .size-input-row input {
            flex: 1;
        }

        .add-size-btn {
            padding: 0.75rem 1.5rem;
            border: 2px dashed var(--accent-primary);
            border-radius: 10px;
            background: transparent;
            color: var(--accent-primary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .add-size-btn:hover {
            background: var(--accent-primary);
            color: white;
        }

        .remove-size-btn {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 8px;
            background: var(--error-color);
            color: white;
            cursor: pointer;
            font-weight: 600;
        }

        .remove-size-btn:hover {
            background: #c53030;
        }

        .submit-btn {
            width: 100%;
            padding: 1.1rem;
            border: none;
            border-radius: 12px;
            background: var(--accent-primary);
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 1rem;
            letter-spacing: 1px;
        }

        .submit-btn:hover {
            background: var(--accent-primary-hover);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(56, 161, 105, 0.3);
        }

        .submit-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .message {
            text-align: center;
            margin-top: 1rem;
            font-size: 1rem;
            min-height: 1.5rem;
            font-weight: 600;
        }

        .error { color: var(--error-color); }
        .success { color: var(--success-color); }

        /* History Table Styles */
        .table-wrapper {
            overflow-x: auto;
            margin-top: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
        }

        thead {
            background: var(--accent-primary);
            color: white;
        }

        th, td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            font-weight: 700;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        tbody tr {
            transition: background-color 0.2s ease;
        }

        tbody tr:hover {
            background: var(--bg-primary);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .no-data, .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: var(--bg-primary);
            margin: 10% auto;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 10px 40px var(--shadow-color);
            animation: slideIn 0.3s ease;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--error-color);
        }

        .modal-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .modal-content h2 {
            color: var(--accent-primary);
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .modal-content p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .modal-btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 10px;
            background: var(--accent-primary);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn:hover {
            background: var(--accent-primary-hover);
        }
        
        .action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 0.5rem;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .edit-btn {
            background-color: #3b82f6;
            color: white;
        }

        .edit-btn:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
        }

        .delete-btn {
            background-color: #ef4444;
            color: white;
        }

        .delete-btn:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column-reverse;
                align-items: stretch;
            }
            .controls-container {
                justify-content: space-between;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            .form-container, .history-container {
                padding: 1.5rem;
            }
            th, td {
                padding: 0.75rem 1rem;
                font-size: 0.85rem;
            }
            .action-btn {
                padding: 0.4rem 0.75rem;
                font-size: 0.8rem;
                margin-bottom: 0.25rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-btn" onclick="goBack()" data-translate-key="back_btn">‚Üê Back to Dashboard</button>
        <div class="controls-container">
            <div class="language-switcher">
                <button id="lang-en" class="lang-btn active">EN</button>
                <button id="lang-si" class="lang-btn">‡∑É‡∑í‡∂Ç</button>
            </div>
            <div class="theme-switcher">
                <label class="theme-switch" for="theme-toggle">
                    <input type="checkbox" id="theme-toggle" />
                    <div class="slider"></div>
                </label>
            </div>
        </div>
    </div>

    <div class="form-container">
        <h1 data-translate-key="form_title">‚ú® Add New Design</h1>
        <form id="addDesignForm">
            <div class="form-grid">
                <div class="input-group">
                    <label for="design_code" data-translate-key="design_code_label">Design Code</label>
                    <input type="text" id="design_code" name="design_code" required placeholder="Enter design code">
                </div>
                <div class="input-group">
                    <label for="cloth_purchase_id" data-translate-key="cloth_purchase_label">Cloth Purchase</label>
                    <select id="cloth_purchase_id" name="cloth_purchase_id" required>
                        <option value="" data-translate-key="select_cloth">Select cloth purchase...</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="allocated_yards_per_piece" data-translate-key="yards_per_piece_label">Yards Per Piece</label>
                    <input type="number" id="allocated_yards_per_piece" name="allocated_yards_per_piece" step="0.01" min="0.01" required placeholder="0.00">
                </div>
                <div class="input-group">
                    <label for="number_of_pieces" data-translate-key="number_of_pieces_label">Number of Pieces</label>
                    <input type="number" id="number_of_pieces" name="number_of_pieces" min="1" required placeholder="0">
                </div>

                <div class="size-distribution-section">
                    <h3 data-translate-key="size_distribution_title">Size Distribution</h3>
                    
                    <div class="size-category-selection">
                        <label class="category-checkbox">
                            <input type="checkbox" id="category-s-3xl" onchange="toggleSizeCategory('s-3xl')">
                            <span data-translate-key="category_s_3xl">S-3XL</span>
                        </label>
                        <label class="category-checkbox">
                            <input type="checkbox" id="category-28-38" onchange="toggleSizeCategory('28-38')">
                            <span data-translate-key="category_28_38">28-38</span>
                        </label>
                    </div>
                    <div id="sizes-s-3xl" class="size-category-container" style="display: none;">
                        <h4 data-translate-key="category_s_3xl">S-3XL Sizes</h4>
                        <div class="size-inputs-grid">
                            <div class="input-group"><label>S</label><input type="number" class="size-quantity" data-size="S" min="0" value="0"></div>
                            <div class="input-group"><label>M</label><input type="number" class="size-quantity" data-size="M" min="0" value="0"></div>
                            <div class="input-group"><label>L</label><input type="number" class="size-quantity" data-size="L" min="0" value="0"></div>
                            <div class="input-group"><label>XL</label><input type="number" class="size-quantity" data-size="XL" min="0" value="0"></div>
                            <div class="input-group"><label>2XL</label><input type="number" class="size-quantity" data-size="2XL" min="0" value="0"></div>
                            <div class="input-group"><label>3XL</label><input type="number" class="size-quantity" data-size="3XL" min="0" value="0"></div>
                        </div>
                    </div>
                    <div id="sizes-28-38" class="size-category-container" style="display: none;">
                        <h4 data-translate-key="category_28_38">28-38 Sizes</h4>
                        <div class="size-inputs-grid">
                            <div class="input-group"><label>Free</label><input type="number" class="size-quantity" data-size="Free" min="0" value="0"></div>
                            <div class="input-group"><label>28</label><input type="number" class="size-quantity" data-size="28" min="0" value="0"></div>
                            <div class="input-group"><label>29</label><input type="number" class="size-quantity" data-size="29" min="0" value="0"></div>
                            <div class="input-group"><label>30</label><input type="number" class="size-quantity" data-size="30" min="0" value="0"></div>
                            <div class="input-group"><label>31</label><input type="number" class="size-quantity" data-size="31" min="0" value="0"></div>
                            <div class="input-group"><label>32</label><input type="number" class="size-quantity" data-size="32" min="0" value="0"></div>
                            <div class="input-group"><label>33</label><input type="number" class="size-quantity" data-size="33" min="0" value="0"></div>
                            <div class="input-group"><label>34</label><input type="number" class="size-quantity" data-size="34" min="0" value="0"></div>
                            <div class="input-group"><label>35</label><input type="number" class="size-quantity" data-size="35" min="0" value="0"></div>
                            <div class="input-group"><label>36</label><input type="number" class="size-quantity" data-size="36" min="0" value="0"></div>
                            <div class="input-group"><label>37</label><input type="number" class="size-quantity" data-size="37" min="0" value="0"></div>
                            <div class="input-group"><label>38</label><input type="number" class="size-quantity" data-size="38" min="0" value="0"></div>
                        </div>
                    </div>
                </div>
            </div>
            <button type="submit" class="submit-btn" data-translate-key="submit_btn">Create Design</button>
            <p id="message" class="message"></p>
        </form>
    </div>
    
    <div class="history-container">
        <h2 data-translate-key="history_title">üìú Design History</h2>
        <div id="historyContent">
            <div class="loading" data-translate-key="loading">Loading...</div>
        </div>
    </div>


    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon">‚úÖ</div>
            <h2 data-translate-key="modal_title">Success!</h2>
            <p data-translate-key="modal_message">Design has been created successfully.</p>
            <button class="modal-btn" onclick="closeModalAndRedirect()" data-translate-key="modal_btn">Go to Dashboard</button>
        </div>
    </div>

    <div id="editDesignModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeEditDesignModal">&times;</span>
            <h2 data-translate-key="edit_design_title">Edit Design</h2>
            <form id="editDesignForm">
                <input type="hidden" id="edit-design-id">
                <div class="form-grid">
                    <div class="input-group">
                        <label for="edit-design-code" data-translate-key="design_code_label">Design Code</label>
                        <input type="text" id="edit-design-code" readonly>
                    </div>
                    <div class="input-group">
                        <label for="edit-allocated-yards" data-translate-key="allocated_yards_label">Allocated Yards</label>
                        <input type="number" id="edit-allocated-yards" step="0.01" min="0.01" required>
                    </div>
                </div>
                <button type="submit" class="submit-btn" data-translate-key="save_changes_btn">Save Changes</button>
            </form>
        </div>
    </div>

    <div id="authModal" class="modal">
      <div class="modal-content" style="max-width: 400px;">
        <span class="close-btn" id="closeAuthModal">&times;</span>
        <h2 data-translate-key="auth_required">Authorization Required</h2>
        <p data-translate-key="auth_prompt">Please enter Level 2 credentials to proceed.</p>
        <div class="input-group">
          <label for="username" data-translate-key="username">Username</label>
          <input type="text" id="modal-username" name="username" required>
        </div>
        <div class="input-group">
          <label for="password" data-translate-key="password">Password</label>
          <input type="password" id="modal-password" name="password" required>
        </div>
        <button id="modal-submit" class="submit-btn" data-translate-key="authorize">Authorize</button>
        <p id="modal-error" class="message error"></p>
      </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let allDesigns = [];
            const translations = {
                en: {
                    page_title: "LSP Apparel - Add Design",
                    back_btn: "‚Üê Back to Dashboard",
                    form_title: "‚ú® Add New Design",
                    design_code_label: "Design Code",
                    cloth_purchase_label: "Cloth Purchase",
                    select_cloth: "Select cloth purchase...",
                    yards_per_piece_label: "Yards Per Piece",
                    number_of_pieces_label: "Number of Pieces",
                    size_distribution_title: "Size Distribution",
                    submit_btn: "Create Design",
                    modal_title: "Success!",
                    modal_message: "Design has been created successfully.",
                    modal_btn: "Go to Dashboard",
                    msg_error: "‚úó An error occurred. Please try again.",
                    msg_validation: "‚úó Please fill in all required fields and select at least one size.",
                    history_title: "üìú Design History",
                    loading: "Loading...",
                    th_design_code: "Design Code",
                    th_allocated_yards: "Allocated Yards",
                    th_date: "Date Added",
                    th_actions: "Actions",
                    edit: "Edit",
                    delete: "Delete",
                    delete_success: "Design deleted successfully.",
                    edit_design_title: "Edit Design",
                    allocated_yards_label: "Allocated Yards",
                    save_changes_btn: "Save Changes",
                    update_success: "Design updated successfully.",
                    no_data: "No designs found.",
                    auth_required: "Authorization Required",
                    auth_prompt: "Please enter Level 2 credentials to proceed.",
                    username: "Username",
                    password: "Password",
                    authorize: "Authorize",
                    auth_fail: "‚úó Invalid credentials or insufficient access level."
                },
                si: {
                    page_title: "LSP ‡∂á‡∂≥‡∑î‡∂∏‡∑ä - ‡∂©‡∑í‡∑É‡∂∫‡∑í‡∂±‡∑ä ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±",
                    back_btn: "‚Üê ‡∂ã‡∂¥‡∂ö‡∂ª‡∂´ ‡∂¥‡∑î‡∑Ä‡∂ª‡∑î‡∑Ä‡∂ß ‡∂Ü‡∂¥‡∑É‡∑î",
                    form_title: "‚ú® ‡∂±‡∑Ä ‡∂©‡∑í‡∑É‡∂∫‡∑í‡∂±‡∑ä ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±",
                    design_code_label: "‡∂©‡∑í‡∑É‡∂∫‡∑í‡∂±‡∑ä ‡∂ö‡∑ö‡∂≠‡∂∫",
                    cloth_purchase_label: "‡∂ª‡∑ô‡∂Ø‡∑í ‡∂∏‡∑í‡∂Ω‡∂Ø‡∑ì ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏",
                    select_cloth: "‡∂ª‡∑ô‡∂Ø‡∑í ‡∂∏‡∑í‡∂Ω‡∂Ø‡∑ì ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±...",
                    yards_per_piece_label: "‡∂ë‡∂ö‡∑ä ‡∂ö‡∑í‡∂Ω‡∑ä‡∂Ω‡∂ö‡∂ß ‡∂∫‡∑è‡∂ª",
                    number_of_pieces_label: "‡∂¥‡∑ù‡∑Ç‡∑Ä‡∂Ω‡∑ä ‡∂ú‡∂´‡∂±",
                    size_distribution_title: "‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´ ‡∂∂‡∑ô‡∂Ø‡∑è ‡∑Ñ‡∑ê‡∂ª‡∑ì‡∂∏",
                    submit_btn: "‡∂©‡∑í‡∑É‡∂∫‡∑í‡∂±‡∑ä ‡∑É‡∑è‡∂Ø‡∂±‡∑ä‡∂±",
                    modal_title: "‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í!",
                    modal_message: "‡∂©‡∑í‡∑É‡∂∫‡∑í‡∂±‡∑ä ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∂±‡∑í‡∂ª‡∑ä‡∂∏‡∑è‡∂´‡∂∫ ‡∂ö‡∂ª ‡∂á‡∂≠.",
                    modal_btn: "‡∂ã‡∂¥‡∂ö‡∂ª‡∂´ ‡∂¥‡∑î‡∑Ä‡∂ª‡∑î‡∑Ä‡∂ß ‡∂∫‡∂±‡∑ä‡∂±",
                    msg_error: "‚úó ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑í‡∑Ä‡∑í‡∂∫. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.",
                    msg_validation: "‚úó ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑É‡∑í‡∂∫‡∑Ö‡∑î‡∂∏ ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂ö‡∑ä‡∑Ç‡∑ö‡∂≠‡∑ä‚Äç‡∂ª ‡∂¥‡∑î‡∂ª‡∑Ä‡∂±‡∑ä‡∂± ‡∑É‡∑Ñ ‡∂Ö‡∑Ä‡∂∏ ‡∑Ä‡∑Å‡∂∫‡∑ô‡∂±‡∑ä ‡∂ë‡∂ö‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∂∫‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±.",
                    history_title: "üìú ‡∑É‡∑ê‡∂Ω‡∑É‡∑î‡∂∏‡∑ä ‡∂â‡∂≠‡∑í‡∑Ñ‡∑è‡∑É‡∂∫",
                    loading: "‡∂¥‡∑ê‡∂ß‡∑Ä‡∑ì‡∂∏ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä...",
                    th_design_code: "‡∑É‡∑ê‡∂Ω‡∑É‡∑î‡∂∏‡∑ä ‡∂ö‡∑ö‡∂≠‡∂∫",
                    th_allocated_yards: "‡∑Ä‡∑ô‡∂±‡∑ä ‡∂ö‡∑Ö ‡∂∫‡∑è‡∂ª",
                    th_date: "‡∂ë‡∂ö‡∑ä ‡∂ö‡∑Ö ‡∂Ø‡∑í‡∂±‡∂∫",
                    th_actions: "‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è",
                    edit: "‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±",
                    delete: "‡∂∏‡∂ö‡∂±‡∑ä‡∂±",
                    delete_success: "‡∑É‡∑ê‡∂Ω‡∑É‡∑î‡∂∏ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∂∏‡∂ö‡∑è ‡∂Ø‡∂∏‡∂± ‡∂Ω‡∂Ø‡∑ì.",
                    edit_design_title: "‡∑É‡∑ê‡∂Ω‡∑É‡∑î‡∂∏ ‡∑É‡∂Ç‡∑É‡∑ä‡∂ö‡∂ª‡∂´‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±",
                    allocated_yards_label: "‡∑Ä‡∑ô‡∂±‡∑ä ‡∂ö‡∑Ö ‡∂∫‡∑è‡∂ª",
                    save_changes_btn: "‡∑Ä‡∑ô‡∂±‡∑É‡∑ä‡∂ö‡∂∏‡∑ä ‡∑É‡∑î‡∂ª‡∂ö‡∑í‡∂±‡∑ä‡∂±",
                    update_success: "‡∑É‡∑ê‡∂Ω‡∑É‡∑î‡∂∏ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∑Ä ‡∂∫‡∑è‡∑Ä‡∂≠‡∑ä‡∂ö‡∑è‡∂Ω‡∑ì‡∂± ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì.",
                    no_data: "‡∑É‡∑ê‡∂Ω‡∑É‡∑î‡∂∏‡∑ä ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑ì‡∂∫.",
                    auth_required: "‡∂Ö‡∂±‡∑î‡∂∏‡∂≠ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂∫‡∑í",
                    auth_prompt: "‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂∫‡∂ß ‡∂∫‡∑è‡∂∏‡∂ß ‡∂∏‡∂ß‡∑ä‡∂ß‡∂∏ 2 ‡∂Ö‡∂ö‡∑ä‡∂≠‡∂¥‡∂≠‡∑ä‚Äç‡∂ª ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.",
                    username: "‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö ‡∂±‡∑è‡∂∏‡∂∫",
                    password: "‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫",
                    authorize: "‡∂Ö‡∂±‡∑î‡∂∏‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±",
                    auth_fail: "‚úó ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂Ö‡∂ö‡∑ä‡∂≠‡∂¥‡∂≠‡∑ä‚Äç‡∂ª ‡∑Ñ‡∑ù ‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∑Ä‡∂≠‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑ö‡∑Å ‡∂∏‡∂ß‡∑ä‡∂ß‡∂∏‡∂ö‡∑ä ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠."
                }
            };

            const themeToggle = document.getElementById('theme-toggle');
            const setInitialTheme = () => {
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                    document.body.classList.add('dark-mode');
                    themeToggle.checked = true;
                }
            };
            themeToggle.addEventListener('change', () => {
                if (themeToggle.checked) {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                }
            });

            const langEnBtn = document.getElementById('lang-en');
            const langSiBtn = document.getElementById('lang-si');
            let currentLanguage = localStorage.getItem('language') || 'en';

            const setLanguage = (lang) => {
                currentLanguage = lang;
                localStorage.setItem('language', lang);
                document.querySelectorAll('[data-translate-key]').forEach(el => {
                    const key = el.getAttribute('data-translate-key');
                    if (translations[lang][key]) {
                        if (el.tagName === 'INPUT' && el.type === 'text') {
                            el.placeholder = translations[lang][key];
                        } else {
                            el.textContent = translations[lang][key];
                        }
                    }
                });
                document.documentElement.lang = lang;
                document.title = translations[lang].page_title;
                langEnBtn.classList.toggle('active', lang === 'en');
                langSiBtn.classList.toggle('active', lang === 'si');
            };

            langEnBtn.addEventListener('click', () => setLanguage('en'));
            langSiBtn.addEventListener('click', () => setLanguage('si'));

            setInitialTheme();
            setLanguage(currentLanguage);

            const token = localStorage.getItem('accessToken');
            if (!token) {
                // window.location.href = '/';
            }
            
            const authModal = document.getElementById('authModal');
            const editDesignModal = document.getElementById('editDesignModal');
            const modalError = document.getElementById('modal-error');

            document.getElementById('closeAuthModal').onclick = () => {
                authModal.style.display = "none";
                document.getElementById('modal-username').value = '';
                document.getElementById('modal-password').value = '';
                modalError.textContent = '';
            };
            
            document.getElementById('closeEditDesignModal').onclick = () => editDesignModal.style.display = "none";
            
            window.onclick = function(event) {
                if (event.target == authModal) {
                    authModal.style.display = "none";
                    document.getElementById('modal-username').value = '';
                    document.getElementById('modal-password').value = '';
                    modalError.textContent = '';
                }
                if (event.target == editDesignModal) editDesignModal.style.display = "none";
            }
            
            let currentAction = null;
            let currentItemId = null;
            
            window.handleEdit = (id) => {
                const item = allDesigns.find(d => d.id === id);
                if(item) {
                    document.getElementById('edit-design-id').value = item.id;
                    document.getElementById('edit-design-code').value = item.design_code;
                    document.getElementById('edit-allocated-yards').value = item.allocated_yards;
                    editDesignModal.style.display = 'block';
                }
            }

            window.handleDelete = (id) => {
                if (confirm(translations[currentLanguage].delete_confirm || 'Are you sure you want to delete this design?')) {
                    currentItemId = id;
                    currentAction = 'delete';
                    authModal.style.display = 'block';
                }
            }
            
            document.getElementById('editDesignForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const allocatedYards = parseFloat(document.getElementById('edit-allocated-yards').value);
                
                if (!allocatedYards || allocatedYards <= 0) {
                    alert(translations[currentLanguage].msg_validation);
                    return;
                }
                
                currentItemId = document.getElementById('edit-design-id').value;
                currentAction = 'edit';
                editDesignModal.style.display = 'none';
                authModal.style.display = 'block';
            });

            document.getElementById('modal-submit').addEventListener('click', async () => {
                const username = document.getElementById('modal-username').value.trim();
                const password = document.getElementById('modal-password').value;

                if (!username || !password) {
                    modalError.textContent = translations[currentLanguage].msg_validation;
                    return;
                }

                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);

                try {
                    const response = await fetch('/users/token', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.access_level === 'full_access') {
                            authModal.style.display = 'none';
                            document.getElementById('modal-username').value = '';
                            document.getElementById('modal-password').value = '';
                            modalError.textContent = '';
                            
                            if (currentAction === 'delete') {
                                await deleteDesign(currentItemId, data.access_token);
                            } else if (currentAction === 'edit') {
                                await updateDesign(currentItemId, data.access_token);
                            }
                        } else {
                            modalError.textContent = translations[currentLanguage].auth_fail;
                        }
                    } else {
                        modalError.textContent = translations[currentLanguage].auth_fail;
                    }
                } catch (error) {
                    modalError.textContent = translations[currentLanguage].msg_error;
                }
            });
            
            const messageEl = document.getElementById('message');
            
            const updateDesign = async (id, authToken) => {
                const payload = {
                    allocated_yards: parseFloat(document.getElementById('edit-allocated-yards').value)
                };

                try {
                    const response = await fetch('/designs/operate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ action: "UPDATE", design_id: id, payload: payload })
                    });
                    if (response.ok) {
                        messageEl.className = 'message success';
                        messageEl.textContent = translations[currentLanguage].update_success;
                        setTimeout(() => messageEl.textContent = '', 3000);
                        loadDesignHistory();
                    } else {
                        const error = await response.json();
                        messageEl.className = 'message error';
                        messageEl.textContent = '‚úó ' + (error.detail || translations[currentLanguage].msg_error);
                        setTimeout(() => messageEl.textContent = '', 3000);
                    }
                } catch (error) {
                    messageEl.className = 'message error';
                    messageEl.textContent = translations[currentLanguage].msg_error;
                    setTimeout(() => messageEl.textContent = '', 3000);
                }
            };

            const deleteDesign = async (id, authToken) => {
                try {
                    const response = await fetch('/designs/operate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ action: "DELETE", design_id: id })
                    });

                    if (response.ok) {
                        messageEl.className = 'message success';
                        messageEl.textContent = translations[currentLanguage].delete_success;
                        setTimeout(() => messageEl.textContent = '', 3000);
                        loadDesignHistory();
                    } else {
                        const error = await response.json();
                        messageEl.className = 'message error';
                        messageEl.textContent = '‚úó ' + (error.detail || translations[currentLanguage].msg_error);
                        setTimeout(() => messageEl.textContent = '', 3000);
                    }
                } catch (error) {
                    messageEl.className = 'message error';
                    messageEl.textContent = translations[currentLanguage].msg_error;
                    setTimeout(() => messageEl.textContent = '', 3000);
                }
            };
            
            const loadDesignHistory = async () => {
                const historyContent = document.getElementById('historyContent');
                try {
                    const response = await fetch('/designs/operate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ action: "READ_ALL" })
                    });

                    if (response.ok) {
                        allDesigns = await response.json();
                        if (allDesigns.length === 0) {
                            historyContent.innerHTML = `<div class="no-data">${translations[currentLanguage].no_data}</div>`;
                        } else {
                            const tableHTML = `
                                <div class="table-wrapper">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>${translations[currentLanguage].th_design_code}</th>
                                                <th>${translations[currentLanguage].th_allocated_yards}</th>
                                                <th>${translations[currentLanguage].th_date}</th>
                                                <th>${translations[currentLanguage].th_actions}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${allDesigns.map(item => `
                                                <tr>
                                                    <td>${item.design_code}</td>
                                                    <td>${item.allocated_yards}</td>
                                                    <td>${new Date(item.created_at).toLocaleString()}</td>
                                                    <td>
                                                        <button class="action-btn edit-btn" onclick="handleEdit('${item.id}')">${translations[currentLanguage].edit}</button>
                                                        <button class="action-btn delete-btn" onclick="handleDelete('${item.id}')">${translations[currentLanguage].delete}</button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `;
                            historyContent.innerHTML = tableHTML;
                        }
                    } else {
                        historyContent.innerHTML = `<div class="error">${translations[currentLanguage].msg_error}</div>`;
                    }
                } catch (error) {
                    historyContent.innerHTML = `<div class="error">${translations[currentLanguage].msg_error}</div>`;
                }
            };

            loadClothPurchases();
            loadDesignHistory();

            async function loadClothPurchases() {
                try {
                    const response = await fetch('/cloth-purchases/operate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ action: "READ_ALL" })
                    });

                    if (response.ok) {
                        const purchases = await response.json();
                        const select = document.getElementById('cloth_purchase_id');
                        purchases.forEach(purchase => {
                            const option = document.createElement('option');
                            option.value = purchase.id;
                            option.textContent = `${purchase.cloth_name} - ${purchase.supplier_name} (${purchase.total_yards} yards)`;
                            select.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Error loading cloth purchases:', error);
                }
            }

            const form = document.getElementById('addDesignForm');

            form.addEventListener('submit', async function(event) {
                event.preventDefault();

                const designCode = document.getElementById('design_code').value.trim();
                const clothPurchaseId = document.getElementById('cloth_purchase_id').value;
                const yardsPerPiece = parseFloat(document.getElementById('allocated_yards_per_piece').value);
                const numberOfPieces = parseInt(document.getElementById('number_of_pieces').value);

                if (!designCode || !clothPurchaseId || !yardsPerPiece || yardsPerPiece <= 0 || !numberOfPieces || numberOfPieces <= 0) {
                    messageEl.className = 'message error';
                    messageEl.textContent = translations[currentLanguage].msg_validation;
                    setTimeout(() => messageEl.textContent = '', 3000);
                    return;
                }

                const sizeDistribution = [];
                const allSizeInputs = document.querySelectorAll('.size-quantity[data-size]');
                allSizeInputs.forEach(input => {
                    const sizeName = input.getAttribute('data-size');
                    const quantity = parseInt(input.value) || 0;
                    
                    if (quantity > 0) {
                        sizeDistribution.push({
                            size: sizeName,
                            quantity: quantity
                        });
                    }
                });

                if (sizeDistribution.length === 0) {
                    messageEl.className = 'message error';
                    messageEl.textContent = translations[currentLanguage].msg_validation;
                    setTimeout(() => messageEl.textContent = '', 3000);
                    return;
                }

                const totalSizeQuantity = sizeDistribution.reduce((sum, item) => sum + item.quantity, 0);
                if (totalSizeQuantity !== numberOfPieces) {
                    messageEl.className = 'message error';
                    messageEl.textContent = `‚úó Total size quantities (${totalSizeQuantity}) must equal number of pieces (${numberOfPieces})`;
                    setTimeout(() => messageEl.textContent = '', 5000);
                    return;
                }

                const payload = {
                    action: "CREATE",
                    payload: {
                        design_code: designCode,
                        cloth_purchase_id: clothPurchaseId,
                        allocated_yards_per_piece: yardsPerPiece,
                        number_of_pieces: numberOfPieces,
                        size_distribution: sizeDistribution
                    }
                };

                try {
                    const response = await fetch('/designs/operate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        document.getElementById('successModal').style.display = 'block';
                        form.reset();
                        document.getElementById('category-s-3xl').checked = false;
                        document.getElementById('category-28-38').checked = false;
                        document.getElementById('sizes-s-3xl').style.display = 'none';
                        document.getElementById('sizes-28-38').style.display = 'none';
                        loadDesignHistory();
                    } else {
                        const error = await response.json();
                        messageEl.className = 'message error';
                        messageEl.textContent = '‚úó ' + (error.detail || translations[currentLanguage].msg_error);
                        setTimeout(() => messageEl.textContent = '', 5000);
                    }
                } catch (error) {
                    messageEl.className = 'message error';
                    messageEl.textContent = translations[currentLanguage].msg_error;
                    setTimeout(() => messageEl.textContent = '', 3000);
                }
            });
        });

        function setupEnterKeyNavigation() {
            const form = document.getElementById('addDesignForm');
            form.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.target.tagName !== 'BUTTON') {
                    e.preventDefault();
                    const allInputs = Array.from(form.querySelectorAll('input:not([type="checkbox"]):not([type="submit"]), select'));
                    const visibleInputs = allInputs.filter(input => input.offsetParent !== null && !input.disabled && !input.readOnly);
                    const currentIndex = visibleInputs.indexOf(e.target);
                    
                    if (currentIndex > -1 && currentIndex < visibleInputs.length - 1) {
                        const nextInput = visibleInputs[currentIndex + 1];
                        nextInput.focus();
                        nextInput.select();
                    } else if (currentIndex === visibleInputs.length - 1) {
                        form.dispatchEvent(new Event('submit', { cancelable: true }));
                    }
                }
            });
        }
        setupEnterKeyNavigation();

        function toggleSizeCategory(category) {
            const checkbox = document.getElementById(`category-${category}`);
            const container = document.getElementById(`sizes-${category}`);
            
            if (checkbox.checked) {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
                container.querySelectorAll('.size-quantity').forEach(input => {
                    input.value = 0;
                });
            }
        }

        function closeModalAndRedirect() {
            window.location.href = '/dashboard';
        }

        function goBack() {
            window.location.href = '/dashboard';
        }
    </script>
</body>
</html>